

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Neural network training &mdash; PyPipeline  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="HTTP API generation basics" href="../d05_pypipeline_serve/p01_http_api_generation_basics.html" />
    <link rel="prev" title="Performance tests" href="../d03_advanced/p06_performance_tests.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> PyPipeline
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../d01_overview/overview.html">PyPipeline</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../d02_getting_started/p01_installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../d02_getting_started/p02_minimal_example.html">Minimal example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../d02_getting_started/p03_pipeline_basics.html">Pipeline basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../d02_getting_started/p04_cell_nesting.html">Cell nesting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../d02_getting_started/p05_scale_up_basics.html">Scale-up basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../d02_getting_started/p06_cell_parameters.html">Cell parameters</a></li>
</ul>
<p class="caption"><span class="caption-text">Advanced topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../d03_advanced/p01_architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../d03_advanced/p02_topology_determination.html">Topology determination</a></li>
<li class="toctree-l1"><a class="reference internal" href="../d03_advanced/p03_pull_based_execution.html">Pull-based execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../d03_advanced/p04_validation.html">Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../d03_advanced/p05_scalable_cells_revisited.html">Scalable cells revisited</a></li>
<li class="toctree-l1"><a class="reference internal" href="../d03_advanced/p06_performance_tests.html">Performance tests</a></li>
</ul>
<p class="caption"><span class="caption-text">Deep learning</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Neural network training</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#source-cell-fetching-data-from-a-pytorch-dataloader">Source cell fetching data from a PyTorch DataLoader</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pytorch-dataset-and-dataloader-fetching-data-from-a-pipeline">PyTorch Dataset and DataLoader fetching data from a pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pipeline-reset-before-each-epoch">Pipeline reset before each epoch</a></li>
<li class="toctree-l2"><a class="reference internal" href="#examples">Examples</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">PyPipeline Serve</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../d05_pypipeline_serve/p01_http_api_generation_basics.html">HTTP API generation basics</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">PyPipeline</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Neural network training</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/d04_deep_learning/p01_neural_network_training.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="neural-network-training">
<h1>Neural network training<a class="headerlink" href="#neural-network-training" title="Permalink to this headline">¶</a></h1>
<p>PyPipeline will provide tools for easily integrating with other libraries in the <code class="docutils literal notranslate"><span class="pre">pypipeline_lib</span></code> package.</p>
<dl class="simple">
<dt>Currently, tools are available to interact easily with the PyTorch library for deep learning.</dt><dd><ul class="simple">
<li><p>A source cell that fetches its data from a PyTorch DataLoader.</p></li>
<li><p>PyTorch Dataset and DataLoader objects that fetch their data from a pipeline.</p></li>
<li><p>A control flow system to handle pipeline resets and data reshuffling between training epochs, etc…</p></li>
</ul>
</dd>
</dl>
<div class="section" id="source-cell-fetching-data-from-a-pytorch-dataloader">
<h2>Source cell fetching data from a PyTorch DataLoader<a class="headerlink" href="#source-cell-fetching-data-from-a-pytorch-dataloader" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">pypipeline_lib.torch.DataLoaderSourceCell</span></code> is a cell that can be configured with a PyTorch DataLoader.
The dataloader should at each iteration provide a (sample, label) pair, which the source cell will set
at its corresponding outputs.</p>
<div class="figure align-default" id="id1">
<img alt="../_images/pypipeline-docs-neural-networks-dataloadersourcecell.png" src="../_images/pypipeline-docs-neural-networks-dataloadersourcecell.png" />
<p class="caption"><span class="caption-text">A DataLoaderSourceCell.</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<p>When the dataloader has batch size 1, the source cell can be configured to remove the batch dimension from the sample
and label (=stream-wise dataloading).</p>
<p>Example of stream-wise dataloading:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">Tensor</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">random_split</span>
<span class="kn">from</span> <span class="nn">torchvision.datasets</span> <span class="kn">import</span> <span class="n">MNIST</span>
<span class="kn">from</span> <span class="nn">torchvision.transforms.functional</span> <span class="kn">import</span> <span class="n">to_tensor</span>

<span class="c1"># Prepare Dataset and Dataloader to provide to our dataloader source cells.</span>
<span class="n">mnist_train</span> <span class="o">=</span> <span class="n">MNIST</span><span class="p">(</span><span class="s2">&quot;mnist/&quot;</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">to_tensor</span><span class="p">)</span>
<span class="n">mnist_test</span> <span class="o">=</span> <span class="n">MNIST</span><span class="p">(</span><span class="s2">&quot;mnist/&quot;</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">to_tensor</span><span class="p">)</span>

<span class="c1"># Our data flows one by one through the pipeline during training, so we must use batch size one</span>
<span class="n">mnist_train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">mnist_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># We just make a single source cell as example, but you can just as well embed this cell in your pipeline.</span>
<span class="n">source</span><span class="p">:</span> <span class="n">DataLoaderSourceCell</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="n">DataLoaderSourceCell</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">)</span>
<span class="n">source</span><span class="o">.</span><span class="n">config_dataloader</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">mnist_train_loader</span><span class="p">)</span>
<span class="c1"># As our data flows one by one through the pipeline, we want to remove the batch dimension:</span>
<span class="n">source</span><span class="o">.</span><span class="n">config_remove_batch_dimension</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">source</span><span class="o">.</span><span class="n">deploy</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Available pulls: </span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="n">get_nb_available_pulls</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">source</span><span class="o">.</span><span class="n">pull</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">output_sample</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">output_label</span><span class="o">.</span><span class="n">get_value</span><span class="p">())</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Available pulls: 60000
torch.Size([1, 28, 28])
tensor(8)
</pre></div>
</div>
<p>Example of batch-wise dataloading:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mnist_test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">mnist_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">source</span><span class="o">.</span><span class="n">config_dataloader</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">mnist_test_loader</span><span class="p">)</span>
<span class="n">source</span><span class="o">.</span><span class="n">config_remove_batch_dimension</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>       <span class="c1"># Default is False, so this line isn&#39;t strictly necessary</span>

<span class="n">source</span><span class="o">.</span><span class="n">deploy</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Available pulls: </span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="n">get_nb_available_pulls</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">source</span><span class="o">.</span><span class="n">pull</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">output_sample</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">output_label</span><span class="o">.</span><span class="n">get_value</span><span class="p">())</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Available pulls: 2500
torch.Size([4, 1, 28, 28])
tensor([0, 7, 8, 0])
</pre></div>
</div>
</div>
<div class="section" id="pytorch-dataset-and-dataloader-fetching-data-from-a-pipeline">
<h2>PyTorch Dataset and DataLoader fetching data from a pipeline<a class="headerlink" href="#pytorch-dataset-and-dataloader-fetching-data-from-a-pipeline" title="Permalink to this headline">¶</a></h2>
<p>When you train models in PyTorch, you usually create a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> and <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code> to efficiently provide
data to your model.</p>
<p>Imagine that you have build up a pipeline with a few heavy preprocessing steps, followed by a model to be trained.
The model cell can pull its inputs to fetch data from the pipeline and provide it to the model training code,
but we would like to have this data fetching done with the same interface as the PyTorch dataset. (This can
for example be useful to integrate with model training frameworks like PyTorch Lightning.)</p>
<p>PyPipeline provides implementations of the PyTorch dataset and dataloader interfaces in the <code class="docutils literal notranslate"><span class="pre">pypipeline_lib</span></code>
package: <code class="docutils literal notranslate"><span class="pre">pypipeline_lib.torch.CellInputDataset</span></code> and <code class="docutils literal notranslate"><span class="pre">pypipeline_lib.torch.CellInputDataLoader</span></code>.
You initialize the CellInputDataset with the inputs from which it should fetch its data, and at every iteration,
it will pull each input once and provide the input values as a tuple or list.</p>
<p>If your source cells implement the <code class="docutils literal notranslate"><span class="pre">get_nb_available_pulls()</span></code> method, you can even request the <code class="docutils literal notranslate"><span class="pre">len()</span></code> of
your dataset or dataloader.</p>
<p>See the following code as example. Note that it uses a form of advanced control flow: during one pull of the TestCell,
the TestCell inputs get pulled until the source raises a <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="kn">from</span> <span class="nn">pypipeline.cell</span> <span class="kn">import</span> <span class="n">ASingleCell</span><span class="p">,</span> <span class="n">Pipeline</span>
 <span class="kn">from</span> <span class="nn">pypipeline.cellio</span> <span class="kn">import</span> <span class="n">Input</span><span class="p">,</span> <span class="n">Output</span>
 <span class="kn">from</span> <span class="nn">pypipeline.connection</span> <span class="kn">import</span> <span class="n">Connection</span>
 <span class="kn">from</span> <span class="nn">pypipeline_lib.torch</span> <span class="kn">import</span> <span class="n">CellInputDataset</span><span class="p">,</span> <span class="n">CellInputDataLoader</span>


 <span class="k">class</span> <span class="nc">TestSource</span><span class="p">(</span><span class="n">ASingleCell</span><span class="p">):</span>

     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
         <span class="nb">super</span><span class="p">(</span><span class="n">TestSource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;testsource&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">output_x</span> <span class="o">=</span> <span class="n">Output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">output_y</span> <span class="o">=</span> <span class="n">Output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">counter_max</span> <span class="o">=</span> <span class="mi">10</span>

     <span class="k">def</span> <span class="nf">_on_pull</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_max</span><span class="p">:</span>
             <span class="k">raise</span> <span class="ne">StopIteration</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">output_x</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">output_y</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

     <span class="k">def</span> <span class="nf">get_nb_available_pulls</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_max</span>


 <span class="k">class</span> <span class="nc">TestCell</span><span class="p">(</span><span class="n">ASingleCell</span><span class="p">):</span>

     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
         <span class="nb">super</span><span class="p">(</span><span class="n">TestCell</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;testcell&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">input_x</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">input_y</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

     <span class="k">def</span> <span class="nf">_on_pull</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="hll">         <span class="n">dataset</span> <span class="o">=</span> <span class="n">CellInputDataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_y</span><span class="p">)</span>
</span><span class="hll">         <span class="n">dataloader</span> <span class="o">=</span> <span class="n">CellInputDataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span>
         <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of available CellInputDataLoader iterations: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
             <span class="nb">print</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>


 <span class="k">class</span> <span class="nc">TestPipeline</span><span class="p">(</span><span class="n">Pipeline</span><span class="p">):</span>

     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="nb">super</span><span class="p">(</span><span class="n">TestPipeline</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;testpipeline&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">TestSource</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="n">TestCell</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
         <span class="n">Connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">output_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">input_x</span><span class="p">)</span>
         <span class="n">Connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">output_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">input_y</span><span class="p">)</span>

 <span class="n">p</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
 <span class="n">p</span><span class="o">.</span><span class="n">deploy</span><span class="p">()</span>
 <span class="n">p</span><span class="o">.</span><span class="n">pull</span><span class="p">()</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Number of available CellInputDataLoader iterations: 4
[tensor([0, 1, 2]), tensor([0, 2, 4])]
[tensor([3, 4, 5]), tensor([ 6,  8, 10])]
[tensor([6, 7, 8]), tensor([12, 14, 16])]
[tensor([9]), tensor([18])]
</pre></div>
</div>
</div>
<div class="section" id="pipeline-reset-before-each-epoch">
<h2>Pipeline reset before each epoch<a class="headerlink" href="#pipeline-reset-before-each-epoch" title="Permalink to this headline">¶</a></h2>
<p>Training a neural network model usually takes multiple iterations (epochs) through your train dataset. This means that,
at the start of every new epoch, your pipeline needs to be reset: the source cells should start loading their data from
the start again (possibly with a data reshuffle), eventual stateful preprocessing steps should clear their state, etc…</p>
<p>PyPipeline provides the mechanics for this cell reset: just like a <code class="docutils literal notranslate"><span class="pre">cell.pull()</span></code> call propagates upstream until it
reaches the source cells, a <code class="docutils literal notranslate"><span class="pre">cell.reset()</span></code> propagates and resets all upstream cells too.</p>
<p>When using the CellInputDataset and CellInputDataLoader objects, this reset is automatically called when starting a
new iteration on your dataloader.</p>
<p>The following example extends the previous example with the reset functionality. Note that the source cells
(or any stateful cell!) should override implement the <code class="docutils literal notranslate"><span class="pre">reset()</span></code> method. If you use the <code class="docutils literal notranslate"><span class="pre">DataLoaderSourceCell</span></code>
as source cell in your pipeline, this reset method is already overridden.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When overriding the <code class="docutils literal notranslate"><span class="pre">reset()</span></code> method, don’t forget to call the reset of the superclass!
<code class="docutils literal notranslate"><span class="pre">super(YourCell,</span> <span class="pre">self).reset()</span></code></p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="kn">from</span> <span class="nn">pypipeline.cell</span> <span class="kn">import</span> <span class="n">ASingleCell</span><span class="p">,</span> <span class="n">Pipeline</span>
 <span class="kn">from</span> <span class="nn">pypipeline.cellio</span> <span class="kn">import</span> <span class="n">Input</span><span class="p">,</span> <span class="n">Output</span>
 <span class="kn">from</span> <span class="nn">pypipeline.connection</span> <span class="kn">import</span> <span class="n">Connection</span>

 <span class="k">class</span> <span class="nc">TestSource</span><span class="p">(</span><span class="n">ASingleCell</span><span class="p">):</span>

     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
         <span class="nb">super</span><span class="p">(</span><span class="n">TestSource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;testsource&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">output_x</span> <span class="o">=</span> <span class="n">Output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">output_y</span> <span class="o">=</span> <span class="n">Output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">counter_max</span> <span class="o">=</span> <span class="mi">10</span>

     <span class="k">def</span> <span class="nf">_on_pull</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_max</span><span class="p">:</span>
             <span class="k">raise</span> <span class="ne">StopIteration</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">output_x</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">output_y</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="hll">     <span class="k">def</span> <span class="nf">_on_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span class="hll">         <span class="nb">super</span><span class="p">(</span><span class="n">TestSource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_on_reset</span><span class="p">()</span>
</span><span class="hll">         <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> is reset!&quot;</span><span class="p">)</span>
</span><span class="hll">         <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
</span>
     <span class="k">def</span> <span class="nf">get_nb_available_pulls</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_max</span>

 <span class="k">class</span> <span class="nc">TestCell</span><span class="p">(</span><span class="n">ASingleCell</span><span class="p">):</span>

     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
         <span class="nb">super</span><span class="p">(</span><span class="n">TestCell</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;testcell&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">input_x</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">input_y</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

     <span class="k">def</span> <span class="nf">_on_pull</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">ds</span> <span class="o">=</span> <span class="n">CellInputDataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_y</span><span class="p">)</span>
         <span class="n">dl</span> <span class="o">=</span> <span class="n">CellInputDataLoader</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

         <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of available CellInputDataLoader iterations: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dl</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="hll">         <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span class="hll">             <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
</span><span class="hll">             <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">dl</span><span class="p">:</span>
</span><span class="hll">                 <span class="nb">print</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
</span>
 <span class="k">class</span> <span class="nc">TestPipeline</span><span class="p">(</span><span class="n">Pipeline</span><span class="p">):</span>

     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="nb">super</span><span class="p">(</span><span class="n">TestPipeline</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;testpipeline&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">TestSource</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="n">TestCell</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
         <span class="n">Connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">output_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">input_x</span><span class="p">)</span>
         <span class="n">Connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">output_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">input_y</span><span class="p">)</span>

 <span class="n">p</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
 <span class="n">p</span><span class="o">.</span><span class="n">deploy</span><span class="p">()</span>
 <span class="n">p</span><span class="o">.</span><span class="n">pull</span><span class="p">()</span>
</pre></div>
</div>
<p>Output: (TODO solve the reset() being called for every output the cell contains. It has no negative side effects, but
is not super clean)</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Number of available CellInputDataLoader iterations: 4
Epoch 0:
TestSource(&quot;testsource&quot;) is reset!
TestSource(&quot;testsource&quot;) is reset!
[tensor([0, 1, 2]), tensor([0, 2, 4])]
[tensor([3, 4, 5]), tensor([ 6,  8, 10])]
[tensor([6, 7, 8]), tensor([12, 14, 16])]
[tensor([9]), tensor([18])]
Epoch 1:
TestSource(&quot;testsource&quot;) is reset!
TestSource(&quot;testsource&quot;) is reset!
[tensor([0, 1, 2]), tensor([0, 2, 4])]
[tensor([3, 4, 5]), tensor([ 6,  8, 10])]
[tensor([6, 7, 8]), tensor([12, 14, 16])]
[tensor([9]), tensor([18])]
</pre></div>
</div>
</div>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<div class="section" id="mnist-classification-example">
<h3>1. MNIST classification example<a class="headerlink" href="#mnist-classification-example" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://github.com/JohannesVerherstraeten/pypipeline/blob/main/examples/mnistclassification/mnistclassification.ipynb">Link to the notebook</a>.</p>
<p>Visualization of the MNIST example pipelines:</p>
<div class="figure align-default" id="id2">
<img alt="../_images/mnistclassification-training-pipeline.png" src="../_images/mnistclassification-training-pipeline.png" />
<p class="caption"><span class="caption-text">MNIST classification training pipeline</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<div class="figure align-default" id="id3">
<img alt="../_images/mnistclassification-inference-pipeline.png" src="../_images/mnistclassification-inference-pipeline.png" />
<p class="caption"><span class="caption-text">MNIST classification (scalable) inference pipeline</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../d05_pypipeline_serve/p01_http_api_generation_basics.html" class="btn btn-neutral float-right" title="HTTP API generation basics" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../d03_advanced/p06_performance_tests.html" class="btn btn-neutral float-left" title="Performance tests" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Johannes Verherstraeten.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>